<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#0f172a">
<link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üî•</text></svg>">
<title>Track - Fitness Analytics</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/hammerjs@2.0.8"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>
<script src="https://cdn.tailwindcss.com"></script>

<style>
body{background:radial-gradient(circle at 20% 20%,#1e293b,#020617 70%); -webkit-tap-highlight-color: transparent;} 
.glass{background:rgba(15,23,42,.6);backdrop-filter:blur(18px);border:1px solid rgba(148,163,184,.1)}
.no-scrollbar::-webkit-scrollbar { display: none; }
.no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
input[type=number] { -moz-appearance: textfield; appearance: textfield; }
.weekPhoto{width:32px;height:32px;object-fit:cover;border-radius:6px;border:1px solid rgba(255,255,255,.1);cursor:pointer;transition:transform 0.2s;}
@media (min-width: 768px) { .weekPhoto{width:46px;height:46px;border-radius:10px;} }
.weekPhoto:hover{transform:scale(1.1);}
.avgHighlight{font-weight:700;color:#818cf8;background:rgba(99,102,241,.15);border-radius:6px;padding:4px 6px;transition:.25s ease; white-space:nowrap;}
@media (min-width: 640px) { .avgHighlight{border-radius:8px;padding:6px 8px;} }
.avgPulse{animation:avgPulseAnim .35s ease}
@keyframes avgPulseAnim{0%{transform:scale(1)}50%{transform:scale(1.08)}100%{transform:scale(1)}}
.currentDayGlow{border:1px solid #818cf8 !important;box-shadow:0 0 12px rgba(129,140,248,.8), inset 0 0 6px rgba(129,140,248,.4);animation:dayGlow 1.8s ease-in-out infinite alternate}
@keyframes dayGlow{from{box-shadow:0 0 6px rgba(129,140,248,.4)}to{box-shadow:0 0 16px rgba(129,140,248,1)}}
.timelineTrail{position:relative;padding-left:28px}
.timelineTrail:before{content:"";position:absolute;left:10px;top:0;bottom:0;width:2px;background:linear-gradient(to bottom,#6366f1,transparent)}
.timelineCard{position:relative;border-radius:20px;overflow:hidden;aspect-ratio:3/4;display:flex;align-items:center;justify-content:center}
.timelineCard img{width:100%;height:100%;object-fit:cover;border-radius:18px;cursor:pointer}
.timelineOverlay{position:absolute;bottom:0;left:0;right:0;padding:16px;text-align:center;background:linear-gradient(to top,rgba(0,0,0,.8),transparent);font-weight:600; pointer-events: none;}
.measureCard{background:linear-gradient(180deg,rgba(99,102,241,.10),rgba(15,23,42,.6));border:1px solid rgba(99,102,241,.25);border-radius:18px;padding:20px;position:relative}
.measureInput{background:#020617;border-radius:8px;padding:8px;text-align:center;width:85px;font-size:16px;}
.measureInput:focus{outline:2px solid #6366f1;}
.measureChangeUp{color:#4ade80;font-size:13px}
.measureChangeDown{color:#f87171;font-size:13px}
.measureActions{display:flex;gap:8px;margin-top:16px}
.measureBtn{background:rgba(99,102,241,.15);border:1px solid rgba(99,102,241,.35);padding:8px 12px;border-radius:8px;font-size:13px;font-weight:500;cursor:pointer;transition:all 0.2s;flex:1;}
.measureBtn:hover:not(:disabled){background:rgba(99,102,241,.3);}
.measureBtn:disabled{opacity:0.5;cursor:not-allowed;}
.measureHistoryPanel{margin-top:12px;font-size:13px;color:#cbd5f5;max-height:220px;overflow:auto;border-left:2px solid rgba(99,102,241,.4);padding-left:12px;padding-right:14px;scrollbar-gutter:stable;}
.measureHistoryItem{position:relative;padding:8px 0 8px 12px}
.measureHistoryItem:before{content:"";position:absolute;left:-9px;top:15px;width:8px;height:8px;border-radius:50%;background:#818cf8;box-shadow:0 0 10px rgba(129,140,248,.8)}
.sparkleBurst{position:fixed;pointer-events:none;inset:0;display:flex;align-items:center;justify-content:center;z-index:9999}
.sparkleDot{width:6px;height:6px;border-radius:50%;background:#818cf8;position:absolute;animation:sparkleAnim .6s ease-out forwards}
@keyframes sparkleAnim{0%{transform:scale(0);opacity:1}80%{opacity:1}100%{transform:translate(var(--x),var(--y)) scale(1.4);opacity:0}}
.measureDelete{font-size:12px;color:#f87171;margin-left:8px;cursor:pointer; padding: 4px;}
.toast{position:fixed;bottom:32px;left:50%;transform:translateX(-50%) translateY(20px);background:rgba(15,23,42,.95);border:1px solid rgba(99,102,241,.5);padding:12px 24px;border-radius:12px;font-size:15px;font-weight:500;backdrop-filter:blur(10px);opacity:0;transition:.35s ease;z-index:9999;box-shadow:0 4px 12px rgba(0,0,0,0.3); white-space:nowrap;}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0)}
.loader { border: 2px solid rgba(255,255,255,0.1); border-left-color: #818cf8; border-radius: 50%; width: 16px; height: 16px; animation: spin 1s linear infinite; display: inline-block; vertical-align: middle; margin-right: 6px;}
@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
.slide-fade { animation: slideFadeAnim 0.35s cubic-bezier(0.16, 1, 0.3, 1); }
@keyframes slideFadeAnim { 0% { transform: translateY(15px); opacity: 0; } 100% { transform: translateY(0); opacity: 1; } }
.modal-pop { animation: modalPopAnim 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
@keyframes modalPopAnim { 0% { transform: scale(0.9); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
.sticky-col { position: sticky; left: 0; background: rgba(15,23,42,0.95); backdrop-filter: blur(10px); z-index: 10; border-right: 1px solid rgba(148,163,184,0.15); box-shadow: 2px 0 5px rgba(0,0,0,0.1); }
th.sticky-col { z-index: 20; }
</style>
</head>
<body class="text-white min-h-screen px-2 sm:px-5 md:px-8 pb-12 sm:pb-8 selection:bg-indigo-500/30">

<!-- Auth Screen Overlay -->
<div id="authScreen" class="fixed inset-0 bg-[#020617]/95 backdrop-blur-md z-[9999] flex flex-col items-center justify-center transition-opacity duration-500 overflow-y-auto py-8">
    
    <!-- Splash Loader (Shows during Firebase check) -->
    <div id="initialLoader" class="flex flex-col items-center justify-center animate-pulse">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-20 h-20 text-indigo-500 drop-shadow-[0_0_15px_rgba(99,102,241,0.5)]">
            <path fill-rule="evenodd" d="M12.963 2.286a.75.75 0 0 0-1.071-.136 9.742 9.742 0 0 0-3.539 6.176 7.547 7.547 0 0 1-1.705-1.715.75.75 0 0 0-1.152-.082A9 9 0 1 0 15.68 4.534a7.46 7.46 0 0 1-2.717-2.248ZM15.75 14.25a3.75 3.75 0 1 1-7.313-1.172c.628.465 1.35.81 2.133 1a5.99 5.99 0 0 1 1.925-3.546 3.75 3.75 0 0 1 3.255 3.718Z" clip-rule="evenodd" />
        </svg>
    </div>

    <!-- Actual Login Card (Hidden initially) -->
    <div id="authCard" class="hidden glass p-8 sm:p-10 rounded-3xl flex-col items-center text-center max-w-md w-[90%] shadow-[0_0_40px_rgba(99,102,241,0.2)] border border-white/10 my-auto">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-16 h-16 text-indigo-400 mb-4 drop-shadow-lg">
            <path fill-rule="evenodd" d="M12.963 2.286a.75.75 0 0 0-1.071-.136 9.742 9.742 0 0 0-3.539 6.176 7.547 7.547 0 0 1-1.705-1.715.75.75 0 0 0-1.152-.082A9 9 0 1 0 15.68 4.534a7.46 7.46 0 0 1-2.717-2.248ZM15.75 14.25a3.75 3.75 0 1 1-7.313-1.172c.628.465 1.35.81 2.133 1a5.99 5.99 0 0 1 1.925-3.546 3.75 3.75 0 0 1 3.255 3.718Z" clip-rule="evenodd" />
        </svg>
        <h2 class="text-4xl font-extrabold text-white tracking-tight mb-3">Track</h2>
        <p class="text-slate-400 text-sm mb-8 px-2">Sign in to sync your progress securely to the cloud.</p>
        
        <div class="flex flex-col gap-5 w-full mb-8 text-left bg-slate-900/50 p-5 rounded-2xl border border-white/5">
            <div class="flex items-center gap-4">
                <div class="bg-indigo-500/20 p-2.5 rounded-xl text-indigo-400 text-xl">üìà</div>
                <div>
                    <h4 class="text-white font-bold text-sm tracking-wide">Smart Analytics</h4>
                    <p class="text-slate-400 text-xs mt-0.5">Automated trend lines & 20-week projections.</p>
                </div>
            </div>
            <div class="flex items-center gap-4">
                <div class="bg-indigo-500/20 p-2.5 rounded-xl text-indigo-400 text-xl">üì∏</div>
                <div>
                    <h4 class="text-white font-bold text-sm tracking-wide">Visual Timeline</h4>
                    <p class="text-slate-400 text-xs mt-0.5">Unlimited photo history backed by cloud storage.</p>
                </div>
            </div>
            <div class="flex items-center gap-4">
                <div class="bg-indigo-500/20 p-2.5 rounded-xl text-indigo-400 text-xl">üîí</div>
                <div>
                    <h4 class="text-white font-bold text-sm tracking-wide">Cloud Sync</h4>
                    <p class="text-slate-400 text-xs mt-0.5">Access your data seamlessly across all devices.</p>
                </div>
            </div>
        </div>
        
        <button id="googleLoginBtn" class="w-full bg-white text-slate-900 font-bold py-3 px-4 rounded-xl flex items-center justify-center gap-3 hover:bg-slate-100 active:scale-95 transition-all shadow-md">
            <svg class="w-5 h-5" viewBox="0 0 24 24"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/></svg>
            Continue with Google
        </button>
    </div>
</div>

<div class="max-w-[1400px] mx-auto space-y-4 sm:space-y-6 md:space-y-8">

<!-- Responsive Header (Sticky) -->
<div class="sticky top-0 z-[60] pt-2 sm:pt-2 md:pt-3 pb-2 sm:pb-3 mb-2 sm:mb-4 md:mb-6 backdrop-blur-2xl bg-[#0f172a]/95 -mx-2 px-2 sm:-mx-5 sm:px-5 md:-mx-8 md:px-8 border-b border-white/10 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 sm:gap-4 shadow-[0_10px_30px_-10px_rgba(0,0,0,0.5)]">
<div class="flex flex-col items-start justify-center flex-1">
<div class="flex items-center gap-1.5 sm:gap-2.5 w-full justify-between sm:justify-start">
    <div class="flex items-center gap-1.5 sm:gap-2.5">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-7 h-7 sm:w-9 sm:h-9 md:w-12 md:h-12 text-slate-100">
            <path fill-rule="evenodd" d="M12.963 2.286a.75.75 0 0 0-1.071-.136 9.742 9.742 0 0 0-3.539 6.176 7.547 7.547 0 0 1-1.705-1.715.75.75 0 0 0-1.152-.082A9 9 0 1 0 15.68 4.534a7.46 7.46 0 0 1-2.717-2.248ZM15.75 14.25a3.75 3.75 0 1 1-7.313-1.172c.628.465 1.35.81 2.133 1a5.99 5.99 0 0 1 1.925-3.546 3.75 3.75 0 0 1 3.255 3.718Z" clip-rule="evenodd" />
        </svg>
        <h1 class="text-2xl sm:text-3xl md:text-4xl lg:text-5xl font-extrabold tracking-tight text-slate-200">Track</h1>
    </div>
    <button id="openSettingsBtnMobile" class="glass w-10 h-10 flex items-center justify-center rounded-full overflow-hidden hover:bg-white/10 transition-colors shadow-lg active:scale-90 text-lg sm:hidden">‚öôÔ∏è</button>
</div>
<p id="currentWeek" class="text-indigo-300 font-semibold text-[11px] sm:text-sm md:text-base mt-0.5 sm:mt-1 ml-1 sm:ml-1.5 whitespace-nowrap"></p>
</div>
<div class="flex items-center gap-2 sm:gap-3 w-full sm:w-auto">
<div class="grid grid-cols-3 gap-1 sm:flex sm:gap-3 w-full sm:w-auto pb-1 sm:pb-0 flex-1">
<button id="dashboardTab" class="glass px-1 sm:px-6 py-2 md:py-3 rounded-lg sm:rounded-xl transition-all hover:bg-white/10 active:scale-95 font-semibold text-[11px] sm:text-sm md:text-base shadow-sm">üìä <span class="hidden sm:inline">Dashboard</span><span class="sm:hidden">Dash</span></button>
<button id="timelineTab" class="glass px-1 sm:px-6 py-2 md:py-3 rounded-lg sm:rounded-xl transition-all hover:bg-white/10 active:scale-95 font-semibold text-[11px] sm:text-sm md:text-base shadow-sm">üß¨ <span class="hidden sm:inline">Timeline</span><span class="sm:hidden">Time</span></button>
<button id="measureTab" class="glass px-1 sm:px-6 py-2 md:py-3 rounded-lg sm:rounded-xl transition-all hover:bg-white/10 active:scale-95 font-semibold text-[11px] sm:text-sm md:text-base shadow-sm">üìè <span class="hidden sm:inline">Measurements</span><span class="sm:hidden">Meas</span></button>
</div>
<button id="openSettingsBtnDesktop" class="glass hidden sm:flex w-12 h-12 items-center justify-center rounded-xl overflow-hidden hover:bg-white/10 transition-colors shadow-lg active:scale-90 text-xl">‚öôÔ∏è</button>
</div>
</div>

<div id="dashboardView" class="space-y-4 sm:space-y-6 md:space-y-8 slide-fade">
<div class="glass rounded-xl sm:rounded-2xl p-0.5 sm:p-3 overflow-x-auto relative no-scrollbar shadow-xl border border-white/5">
<table class="w-full text-center border-collapse text-xs sm:text-sm md:text-base whitespace-nowrap">
<thead><tr>
<th class="sticky-col px-1.5 sm:px-3 md:px-4 py-2 sm:py-3 text-slate-300 font-semibold text-[10px] sm:text-sm md:text-base">Wk</th>
<th class="px-0.5 sm:px-2 md:px-3 py-2 sm:py-3 text-slate-300 font-medium text-[10px] sm:text-sm md:text-base">Mon</th>
<th class="px-0.5 sm:px-2 md:px-3 py-2 sm:py-3 text-slate-300 font-medium text-[10px] sm:text-sm md:text-base">Tue</th>
<th class="px-0.5 sm:px-2 md:px-3 py-2 sm:py-3 text-slate-300 font-medium text-[10px] sm:text-sm md:text-base">Wed</th>
<th class="px-0.5 sm:px-2 md:px-3 py-2 sm:py-3 text-slate-300 font-medium text-[10px] sm:text-sm md:text-base">Thu</th>
<th class="px-0.5 sm:px-2 md:px-3 py-2 sm:py-3 text-slate-300 font-medium text-[10px] sm:text-sm md:text-base">Fri</th>
<th class="px-0.5 sm:px-2 md:px-3 py-2 sm:py-3 text-slate-300 font-medium text-[10px] sm:text-sm md:text-base">Sat</th>
<th class="px-0.5 sm:px-2 md:px-3 py-2 sm:py-3 text-slate-300 font-medium text-[10px] sm:text-sm md:text-base">Sun</th>
<th class="px-1.5 sm:px-3 py-2 sm:py-3 text-slate-300 font-medium text-[10px] sm:text-sm md:text-base">Img</th>
<th class="px-1.5 sm:px-3 md:px-4 py-2 sm:py-3 text-indigo-300 font-bold text-[10px] sm:text-sm md:text-base" id="headerAvg">Avg</th>
</tr></thead>
<tbody id="tableBody"></tbody>
</table>
</div>
<div class="flex justify-center gap-4">
<button id="expandBtn" class="glass px-6 py-2.5 rounded-xl hover:bg-white/10 transition-all font-medium text-sm sm:text-base active:scale-95">‚¨á Expand</button>
<button id="collapseBtn" class="glass px-6 py-2.5 rounded-xl hover:bg-white/10 transition-all font-medium text-sm sm:text-base active:scale-95">‚¨Ü Latest</button>
</div>
<div class="glass rounded-2xl p-3 sm:p-5 h-[40vh] min-h-[320px] max-h-[500px] w-full shadow-xl border border-white/5 relative">
    <canvas id="chart"></canvas>
    <div class="absolute top-2 right-4 flex items-center gap-2">
        <span class="text-[10px] text-slate-500 hidden sm:block">üí° Pinch to zoom</span>
        <button id="resetZoomBtn" class="glass px-2 py-1 rounded text-xs text-slate-400 hover:text-white transition-colors">Reset View</button>
    </div>
</div>
</div>

<div id="timelineView" class="hidden slide-fade"><div id="timelineContainer" class="timelineTrail space-y-8 sm:space-y-12"></div></div>
<div id="measureView" class="hidden space-y-6 md:space-y-8 slide-fade"><div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 sm:gap-6" id="measureGrid"></div></div>

<!-- Settings Modal -->
<div id="settingsModal" class="hidden fixed inset-0 bg-slate-900/80 backdrop-blur-sm flex items-center justify-center z-[9000] p-4 opacity-0 transition-opacity duration-300">
    <div class="glass p-6 sm:p-8 rounded-3xl flex flex-col gap-5 w-full max-w-[340px] shadow-2xl border border-slate-600 modal-pop">
        <div class="flex justify-between items-center border-b border-white/10 pb-3">
            <h3 class="font-extrabold text-xl text-indigo-300 tracking-tight">App Settings</h3>
            <button id="closeSettingsBtn" class="bg-white/5 hover:bg-white/10 w-8 h-8 flex items-center justify-center rounded-full text-slate-300 hover:text-white transition">‚úï</button>
        </div>
        <div id="settingsUserArea"></div>
        <div class="space-y-2">
            <span class="text-xs font-semibold text-slate-400 uppercase tracking-wider">Preferences</span>
            <div class="glass p-1 rounded-xl flex w-full relative">
                <button id="unitMetric" class="flex-1 py-2 text-sm font-medium rounded-lg transition-all z-10">Metric <span class="text-[10px] opacity-70">(kg/cm)</span></button>
                <button id="unitImperial" class="flex-1 py-2 text-sm font-medium rounded-lg transition-all z-10">Imperial <span class="text-[10px] opacity-70">(lbs/in)</span></button>
                <div id="unitSlider" class="absolute top-1 bottom-1 w-[calc(50%-4px)] bg-indigo-500 rounded-lg transition-all duration-300 shadow-md"></div>
            </div>
        </div>
        <div class="space-y-2 pt-2 border-t border-white/10 mt-2">
            <button id="signOutBtn" class="w-full glass py-3 rounded-xl text-sm font-bold text-red-400 hover:bg-red-500/20 active:scale-95 transition">Sign Out</button>
        </div>
    </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
import { getStorage, ref, uploadString, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

const firebaseConfig = {
  apiKey: "AIzaSyDqd6nEamjWq_K2ZhVwfsiMy0lguTFzlwU",
  authDomain: "track-0shan.firebaseapp.com",
  projectId: "track-0shan",
  storageBucket: "track-0shan.firebasestorage.app",
  messagingSenderId: "1014268137767",
  appId: "1:1014268137767:web:5c07219922571751d41902"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const storage = getStorage(app);

let userId = null; let dataLoaded = false; let allWeeksData = []; let measurements = {}; let measurementHistory = {};
let currentUnit = localStorage.getItem("eliteUnit") || "metric"; let expansionLevel=0; let currentTab='dashboard'; let openHistoryPanels=new Set();
const bodyParts=["Chest","R ForeArm","L ForeArm","R Bicep","L Bicep","Belly","Hips","R Thigh","L Thigh","R Calf","L Calf"];
const tableBody=document.getElementById("tableBody"); const timelineContainer=document.getElementById("timelineContainer"); const measureGrid=document.getElementById("measureGrid"); const dashboardView=document.getElementById("dashboardView"); const timelineView=document.getElementById("timelineView"); const measureView=document.getElementById("measureView"); const currentWeekText=document.getElementById("currentWeek"); const headerAvgText=document.getElementById("headerAvg");
let activeViewerOverlay = null; let lightboxIndex = 0; let lightboxPhotos = [];

function getWeekNumber(date){const d=new Date(Date.UTC(date.getFullYear(),date.getMonth(),date.getDate()));const dayNum=d.getUTCDay()||7;d.setUTCDate(d.getUTCDate()+4-dayNum);const yearStart=new Date(Date.UTC(d.getUTCFullYear(),0,1));return Math.ceil((((d-yearStart)/86400000)+1)/7)}
const today=new Date();const currentDayIndex=(today.getDay()+6)%7;const currentWeek=getWeekNumber(today);
currentWeekText.innerText=`${today.toDateString()} ‚Ä¢ Week ${currentWeek}`;

function showToast(message) {
    let toast = document.createElement('div'); toast.className = 'toast'; toast.textContent = message; document.body.appendChild(toast);
    void toast.offsetWidth; toast.classList.add('show');
    setTimeout(() => { toast.classList.remove('show'); setTimeout(() => toast.remove(), 350); }, 2000);
}

async function loadDataFromCloud() {
    try {
        const docRef = doc(db, 'users', userId); const docSnap = await getDoc(docRef);
        if (docSnap.exists()) {
            const data = docSnap.data();
            allWeeksData = data.allWeeksData ? JSON.parse(data.allWeeksData) : [];
            measurements = data.measurements ? JSON.parse(data.measurements) : {};
            measurementHistory = data.measurementHistory ? JSON.parse(data.measurementHistory) : {};
        } else {
            allWeeksData = JSON.parse(localStorage.getItem("eliteFitnessData")||"[]");
            measurements = JSON.parse(localStorage.getItem("eliteMeasurements")||"{}");
            measurementHistory = JSON.parse(localStorage.getItem("eliteMeasurementHistory")||"{}");
            if(allWeeksData.length > 0) await saveData(); 
        }
    } catch(e) { showToast("Error loading cloud data"); }
}

async function saveData(){
    localStorage.setItem("eliteFitnessData",JSON.stringify(allWeeksData)); localStorage.setItem("eliteMeasurements",JSON.stringify(measurements)); localStorage.setItem("eliteMeasurementHistory",JSON.stringify(measurementHistory));
    if(!userId) return;
    try {
        const docRef = doc(db, 'users', userId);
        await setDoc(docRef, { allWeeksData: JSON.stringify(allWeeksData), measurements: JSON.stringify(measurements), measurementHistory: JSON.stringify(measurementHistory) });
    } catch(e) { showToast("Sync failed."); }
}

document.getElementById('googleLoginBtn').addEventListener('click', async () => {
    const btn = document.getElementById('googleLoginBtn'); btn.disabled = true; btn.innerHTML = '<span class="loader"></span>...';
    try { const provider = new GoogleAuthProvider(); await signInWithPopup(auth, provider); } 
    catch (e) { showToast("Login failed."); btn.disabled = false; btn.innerHTML = 'Continue with Google'; }
});

onAuthStateChanged(auth, async (user) => {
    if (user) {
        userId = user.uid;
        const photoUrl = user.photoURL || 'https://ui-avatars.com/api/?name=User&background=6366f1&color=fff';
        const imgHTML = `<img src="${photoUrl}" referrerpolicy="no-referrer" alt="Profile" class="w-full h-full object-cover">`;
        document.getElementById('openSettingsBtnMobile').innerHTML = imgHTML; document.getElementById('openSettingsBtnDesktop').innerHTML = imgHTML;
        const userArea = document.getElementById('settingsUserArea');
        if (userArea) { userArea.innerHTML = `<div class="flex items-center gap-3 bg-slate-800/50 p-3 rounded-xl border border-white/5"><img src="${photoUrl}" referrerpolicy="no-referrer" class="w-11 h-11 rounded-full object-cover shadow-sm"><div class="text-left overflow-hidden"><p class="text-sm font-bold text-white truncate">${user.displayName || 'User'}</p><p class="text-[11px] text-slate-400 truncate mt-0.5">${user.email || ''}</p></div></div>`; }
        
        document.getElementById('authScreen').classList.add('opacity-0', 'pointer-events-none');
        setTimeout(() => document.getElementById('authScreen').classList.add('hidden'), 500);
        if(!dataLoaded) { await loadDataFromCloud(); dataLoaded = true; ensureCurrentWeekExists(); updateAverages(); renderTable(); }
    } else {
        userId = null; document.getElementById('openSettingsBtnMobile').innerHTML = '‚öôÔ∏è'; document.getElementById('openSettingsBtnDesktop').innerHTML = '‚öôÔ∏è';
        if (document.getElementById('settingsUserArea')) document.getElementById('settingsUserArea').innerHTML = '';
        
        // Hide initial splash loader and show actual login card smoothly
        document.getElementById('initialLoader').classList.add('hidden');
        const authCard = document.getElementById('authCard');
        authCard.classList.remove('hidden');
        authCard.classList.add('flex', 'modal-pop');
        
        document.getElementById('authScreen').classList.remove('hidden', 'opacity-0', 'pointer-events-none');
    }
});

function uW() { return currentUnit === 'imperial' ? 'lbs' : 'kg'; }
function uM() { return currentUnit === 'imperial' ? 'in' : 'cm'; }
function toDispW(val) { if(val===null || val===undefined || val==="") return ""; return currentUnit==='imperial' ? (parseFloat(val) * 2.20462).toFixed(1) : parseFloat(val).toFixed(1); }
function toSaveW(val) { if(isNaN(val) || val==="" || val===null) return null; return currentUnit==='imperial' ? Number((parseFloat(val) / 2.20462).toFixed(2)) : Number(val); }
function toDispM(val) { if(!val || val==="") return ""; return currentUnit==='imperial' ? (parseFloat(val) * 0.393701).toFixed(1) : parseFloat(val).toFixed(1); }
function toSaveM(val) { if(isNaN(val) || val==="") return 0; return currentUnit==='imperial' ? Number((parseFloat(val) / 0.393701).toFixed(2)) : Number(val); }

function compressImage(file, maxSize = 1080) {
    return new Promise((resolve) => {
        const reader = new FileReader(); reader.readAsDataURL(file);
        reader.onload = (event) => {
            const img = new Image(); img.src = event.target.result;
            img.onload = () => {
                const canvas = document.createElement('canvas'); let w = img.width; let h = img.height;
                if (w > h) { if (w > maxSize) { h *= maxSize / w; w = maxSize; } } else { if (h > maxSize) { w *= maxSize / h; h = maxSize; } }
                canvas.width = w; canvas.height = h; const ctx = canvas.getContext('2d'); ctx.drawImage(img, 0, 0, w, h);
                resolve(canvas.toDataURL('image/jpeg', 0.85)); 
            };
        };
    });
}

function ensureCurrentWeekExists(){while(allWeeksData.length<currentWeek){allWeeksData.push({weights:Array(7).fill(null),avg:null,photo:null})}saveData()}

const chart=new Chart(document.getElementById('chart'),{
    type:'line', data:{ labels:[], datasets:[{ label:'Weekly Avg', data:[], borderWidth:3, tension:.4, pointHitRadius: 35 }, { label:'Trend', data:[], borderDash:[6,6], borderWidth:2, tension:.4, pointHitRadius: 35 }]},
    options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{labels:{color:'white'}}, tooltip:{callbacks:{label:(c)=>c.dataset.label+': '+c.parsed.y+' '+uW()}}, zoom:{pan:{enabled:true,mode:'x'},zoom:{wheel:{enabled:true},pinch:{enabled:true},mode:'x'}}}, scales:{y:{ticks:{color:'white'}},x:{ticks:{color:'white'}}}, interaction:{mode:'index',intersect:false}}
});
document.getElementById('resetZoomBtn').onclick = () => chart.resetZoom();

function calculateTrend(data){let recent=data.slice(-15);let pts=recent.map((y,i)=>y!==null?{x:i,y:parseFloat(y)}:null).filter(Boolean);if(pts.length<2)return{slope:0,intercept:0};let n=pts.length,sX=0,sY=0,sXY=0,sXX=0;pts.forEach(p=>{sX+=p.x;sY+=p.y;sXY+=p.x*p.y;sXX+=p.x*p.x});let slope=(n*sXY-sX*sY)/(n*sXX-sX*sX);let intercept=(sY-slope*sX)/n;return{slope,intercept}}

function updateAverages(){
    allWeeksData.forEach(w=>{if(!w)return;let sum=0,count=0;(w.weights||[]).forEach(v=>{if(v!==null&&!isNaN(v)){sum+=parseFloat(v);count++}});w.avg=count?Number((sum/count).toFixed(2)):null;});
    let C = allWeeksData.length; let S = Math.max(1, C - 14); let labels = []; let dispAvg = []; let trendIn = [];
    for (let i = S - 1; i < C; i++) { let w = allWeeksData[i]; trendIn.push(w && w.avg !== null ? Number(toDispW(w.avg)) : null); }
    let {slope, intercept} = calculateTrend(trendIn); let trendData = [];
    for (let i = 0; i < 20; i++) { let wk = S + i; labels.push(`W${wk}`); if (wk <= C) { let w = allWeeksData[wk-1]; dispAvg.push(w && w.avg !== null ? Number(toDispW(w.avg)) : null); } else { dispAvg.push(null); } trendData.push(Number((slope * i + intercept).toFixed(2))); }
    chart.data.labels = labels; chart.data.datasets[0].data = dispAvg; chart.data.datasets[1].data = trendData; chart.update();
    saveData(); headerAvgText.innerText = `Avg (${uW()})`;
}

function getVisibleWeeks(){if(expansionLevel===0)return allWeeksData.slice(currentWeek-1,currentWeek);if(expansionLevel===1)return allWeeksData.slice(Math.max(0,currentWeek-10),currentWeek);return allWeeksData}

function renderTable(){
    if(currentTab!=='dashboard')return; tableBody.innerHTML=""; const visible=getVisibleWeeks(); const startIdx=allWeeksData.length-visible.length;
    visible.forEach((w,vIdx)=>{
        if(!w)return; let rIdx=startIdx+vIdx; let row=document.createElement("tr"); row.className = "border-t border-slate-700/40 hover:bg-slate-800/40 group transition-colors";
        let cells=`<td class="sticky-col py-2 px-1.5 text-[11px] sm:text-base font-semibold group-hover:bg-slate-800/60 transition-colors">${rIdx+1}</td>`;
        for(let j=0;j<7;j++){ let rV=w.weights[j]??""; let dV=toDispW(rV); let glow=(rIdx===currentWeek-1&&j===currentDayIndex)?" currentDayGlow":""; cells+=`<td><input type='number' step='0.1' value='${dV}' class='weightInput bg-slate-900/80 border border-slate-700/80 rounded-md sm:rounded-lg py-1 px-0.5 w-[34px] sm:w-20 text-[11px] sm:text-base text-center transition-all${glow}' data-week='${rIdx}' data-day='${j}'></td>` }
        if(w.photo){ cells+=`<td><div class="flex justify-center"><img src='${w.photo}' class='weekPhoto shadow-md' data-week='${rIdx}' data-dashphoto='true'></div></td>`; } else { cells+=`<td><div class="flex justify-center"><button class='glass px-1.5 py-1 text-[10px] sm:text-base addPhotoBtn' data-week='${rIdx}'>üì∑</button></div></td>`; }
        cells+=`<td><div class="flex justify-center"><span class='avgHighlight text-[10px] sm:text-base'>${toDispW(w.avg)}</span></div></td>`;
        row.innerHTML=cells; tableBody.appendChild(row)
    })
}

function renderTimeline(){
    if(currentTab!=='timeline')return; timelineContainer.innerHTML=""; let hasPhotos = false;
    allWeeksData.forEach((w,idx)=>{ if(!w || !w.photo) return; hasPhotos = true; let card=document.createElement('div'); card.className='timelineCard glass group w-[90%] sm:w-[420px] border border-white/10'; card.innerHTML=`<img src='${w.photo}' data-timelinephoto='${idx}' class="transition-transform duration-700 group-hover:scale-105"><div class='timelineOverlay backdrop-blur-md'>Week ${idx+1} ‚Ä¢ ${toDispW(w.avg)} ${uW()}</div>`; let wrap=document.createElement('div'); wrap.className = 'flex justify-start'; wrap.appendChild(card); timelineContainer.prepend(wrap); });
    if(!hasPhotos) { timelineContainer.innerHTML = `<div class="text-center py-16 text-slate-400 max-w-md mx-auto">No photos yet. Upload in Dashboard to begin.</div>`; }
}

function renderMeasurements(){
    if(currentTab!=='measure')return; measureGrid.innerHTML="";
    bodyParts.forEach(part=>{
        let dV=toDispM(measurements[part]??0); let logs=measurementHistory[part]||[]; let ch="";
        if(logs.length >= 2){ let l = parseFloat(toDispM(logs[logs.length-1].value)); let p = parseFloat(toDispM(logs[logs.length-2].value)); let diff = l - p; if(diff > 0) ch=`<div class='measureChangeUp font-semibold'>‚ñ≤ +${diff.toFixed(1)} ${uM()}</div>`; else if(diff < 0) ch=`<div class='measureChangeDown font-semibold'>‚ñº ${Math.abs(diff).toFixed(1)} ${uM()}</div>`; }
        let hHTML = openHistoryPanels.has(part) ? (logs.length ? logs.slice().reverse().map((l,i)=>`<div class='measureHistoryItem'><div class='flex justify-between items-center'><span>${new Date(l.date).toLocaleDateString()}</span><span class='measureDelete' data-part='${part}' data-index='${logs.length-1-i}'>‚úï</span></div><div class='text-indigo-300 font-bold'>${toDispM(l.value)} ${uM()}</div></div>`).join('') : "<div class='py-3 text-center'>No logs.</div>") : "";
        let card=document.createElement('div'); card.className='measureCard glass';
        card.innerHTML=`<div class='flex justify-between items-center'><span class='font-bold text-lg'>${part}</span><input type='number' step='0.1' value='${dV||""}' class='measureInput text-lg' data-part='${part}'></div><div class='flex justify-between items-center mt-3'><p class='text-xs text-slate-400'>${uM()}</p>${ch}</div><div class='measureActions'><button class='measureBtn logMeasureBtn' data-part='${part}'>üìù Log</button><button class='measureBtn historyBtn' data-part='${part}'>üìú History</button></div><div class='measureHistoryPanel ${openHistoryPanels.has(part)?'':'hidden'}'>${hHTML}</div>`;
        measureGrid.appendChild(card);
    });
}

function triggerPhotoUpload(wIdx, btn) {
    let input=document.createElement('input'); input.type='file'; input.accept='image/*';
    input.onchange= async (ev)=>{
        let file=ev.target.files[0]; if(!file) return; let old = btn.innerHTML; btn.innerHTML = '<span class="loader"></span>'; btn.disabled = true;
        try { 
            let b64 = await compressImage(file, 1080); 
            if (userId) {
                const photoRef = ref(storage, `users/${userId}/week_${wIdx}.jpg`);
                await uploadString(photoRef, b64, 'data_url');
                const downloadURL = await getDownloadURL(photoRef);
                allWeeksData[wIdx].photo = downloadURL;
            } else {
                allWeeksData[wIdx].photo = b64;
            }
            await saveData(); showToast("Photo Uploaded!"); renderTable(); if(currentTab==='timeline')renderTimeline(); 
        } catch(e) { console.error(e); showToast("Upload failed."); } finally { btn.innerHTML = old; btn.disabled = false; }
    }; input.click();
}

function showPhotoOptionsModal(idx) {
    let ov = document.createElement('div'); ov.className = 'fixed inset-0 bg-slate-900/80 backdrop-blur-sm flex items-center justify-center z-[9000] p-4';
    ov.innerHTML = `<div class='glass p-8 rounded-3xl flex flex-col gap-3 w-full max-w-[300px] modal-pop'><h3 class='text-center font-extrabold text-indigo-300'>Photo Options</h3><button class='glass py-3 rounded-xl' id='lbView'>üëÅ View</button><button class='glass py-3 rounded-xl' id='lbChange'>üîÑ Change</button><button class='glass py-3 rounded-xl text-red-400' id='lbRem'>üóë Remove</button><button class='mt-3 text-slate-400' onclick='this.closest(".fixed").remove()'>Cancel</button></div>`;
    document.body.appendChild(ov);
    ov.querySelector('#lbView').onclick = () => { ov.remove(); openLightbox(idx); };
    ov.querySelector('#lbChange').onclick = () => { ov.remove(); triggerPhotoUpload(idx); };
    ov.querySelector('#lbRem').onclick = async () => { 
        let oldPhotoUrl = allWeeksData[idx].photo;
        allWeeksData[idx].photo = null; 
        await saveData(); ov.remove(); renderTable(); if(currentTab==='timeline')renderTimeline(); showToast("Photo removed"); 
        
        if (userId && oldPhotoUrl && oldPhotoUrl.includes('firebasestorage')) {
            try { const photoRef = ref(storage, `users/${userId}/week_${idx}.jpg`); await deleteObject(photoRef); } catch(e) { console.error(e); }
        }
    };
}

function openLightbox(idx) {
    lightboxPhotos = allWeeksData.map((w, i) => ({wIdx: i, photo: w.photo, avg: w.avg})).filter(w => w.photo !== null);
    if(lightboxPhotos.length === 0) return; lightboxIndex = lightboxPhotos.findIndex(p => p.wIdx === idx); if(lightboxIndex === -1) lightboxIndex = 0;
    if(activeViewerOverlay) activeViewerOverlay.remove();
    activeViewerOverlay = document.createElement('div'); activeViewerOverlay.className = 'fixed inset-0 bg-black flex items-center justify-center z-[9999] opacity-0 transition-opacity duration-300 select-none';
    activeViewerOverlay.innerHTML = `<div class="relative w-full h-full flex items-center justify-center overflow-hidden p-2 sm:p-8" id="lbImageContainer"><img id="lbImg" src="" class="max-h-full max-w-full object-contain transition-transform duration-300 rounded-2xl"></div><button class='absolute top-4 right-4 sm:top-6 sm:right-6 bg-slate-800/80 hover:bg-slate-700 text-white w-10 h-10 sm:w-12 sm:h-12 flex items-center justify-center rounded-full closeViewer shadow-lg z-[100] transition-colors'><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 sm:h-6 sm:w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg></button><button class="absolute left-2 sm:left-6 top-1/2 -translate-y-1/2 bg-slate-900/60 hover:bg-slate-800 text-white w-10 h-10 sm:w-14 sm:h-14 flex items-center justify-center rounded-full cursor-pointer z-[100] transition-colors hidden sm:flex shadow-lg" id="lbPrev"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 sm:h-8 sm:w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" /></svg></button><button class="absolute right-2 sm:right-6 top-1/2 -translate-y-1/2 bg-slate-900/60 hover:bg-slate-800 text-white w-10 h-10 sm:w-14 sm:h-14 flex items-center justify-center rounded-full cursor-pointer z-[100] transition-colors hidden sm:flex shadow-lg" id="lbNext"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 sm:h-8 sm:w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7" /></svg></button><div class="absolute bottom-10 sm:bottom-12 left-1/2 -translate-x-1/2 bg-black/50 backdrop-blur-xl border border-white/20 text-white px-6 py-2 sm:px-8 sm:py-3 rounded-full shadow-2xl pointer-events-none z-[100]"><div class="text-sm sm:text-lg font-bold tracking-wide whitespace-nowrap" id="lbWM">Week X ‚Ä¢ Y kg</div></div>`;
    document.body.appendChild(activeViewerOverlay); updateLightbox(); requestAnimationFrame(() => activeViewerOverlay.classList.remove('opacity-0'));
    
    activeViewerOverlay.querySelector('#lbPrev').onclick = (e) => { e.stopPropagation(); if(lightboxIndex < lightboxPhotos.length - 1) { lightboxIndex++; updateLightbox(); } };
    activeViewerOverlay.querySelector('#lbNext').onclick = (e) => { e.stopPropagation(); if(lightboxIndex > 0) { lightboxIndex--; updateLightbox(); } };
    activeViewerOverlay.querySelector('.closeViewer').onclick = closeLightbox;
    
    let tS = 0; activeViewerOverlay.addEventListener('touchstart', e => tS = e.changedTouches[0].screenX);
    activeViewerOverlay.addEventListener('touchend', e => { 
        let diff = e.changedTouches[0].screenX - tS; 
        if(Math.abs(diff) > 50) { 
            if(diff > 0 && lightboxIndex > 0) { 
                lightboxIndex--; updateLightbox(); // swipe right -> past
            } else if (diff < 0 && lightboxIndex < lightboxPhotos.length - 1) { 
                lightboxIndex++; updateLightbox(); // swipe left -> latest
            } 
        } 
    });
}

function updateLightbox() { if(!activeViewerOverlay) return; let d = lightboxPhotos[lightboxIndex]; let i = activeViewerOverlay.querySelector('#lbImg'); let w = activeViewerOverlay.querySelector('#lbWM'); i.style.opacity = '0.5'; setTimeout(() => { i.src = d.photo; w.textContent = `Week ${d.wIdx + 1} ‚Ä¢ ${toDispW(d.avg)} ${uW()}`; i.style.opacity = '1'; }, 150); }
function closeLightbox() { if(activeViewerOverlay) { activeViewerOverlay.classList.add('opacity-0'); setTimeout(() => { if(activeViewerOverlay) activeViewerOverlay.remove(); activeViewerOverlay = null; }, 300); } }

document.addEventListener('input',e=>{
    if(e.target.classList.contains('weightInput')){
        let w=parseInt(e.target.dataset.week); let d=parseInt(e.target.dataset.day); let v=parseFloat(e.target.value); if (v < 0) { v = 0; e.target.value = 0; }
        if(!allWeeksData[w])return; allWeeksData[w].weights[d] = toSaveW(v); updateAverages();
        const r=e.target.closest('tr'); if(r){ const aC=r.querySelector('.avgHighlight'); if(aC){ aC.textContent=toDispW(allWeeksData[w].avg) || 0; aC.classList.remove('avgPulse'); void aC.offsetWidth; aC.classList.add('avgPulse'); } }
    }
    if(e.target.classList.contains('measureInput')){ let p=e.target.dataset.part; let v=parseFloat(e.target.value); if(!isNaN(v) && v >= 0) { measurements[p]=toSaveM(v); clearTimeout(window.mT); window.mT = setTimeout(() => saveData(), 500); } }
});

document.addEventListener('click', async e=>{
    if(e.target.classList.contains('addPhotoBtn')){ triggerPhotoUpload(parseInt(e.target.dataset.week), e.target); }
    let dp = e.target.closest('[data-dashphoto]'); if(dp) showPhotoOptionsModal(parseInt(dp.dataset.week));
    let tp = e.target.closest('[data-timelinephoto]'); if(tp) openLightbox(parseInt(tp.dataset.timelinephoto));
    if(e.target.classList.contains('logMeasureBtn')){
        let btn = e.target; let p=btn.dataset.part; let rV=parseFloat(measurements[p]); if(isNaN(rV)) return;
        let logs=measurementHistory[p]||[]; if (logs.length > 0 && logs[logs.length - 1].value === rV) { showToast("Same as last logged!"); return; }
        btn.disabled = true; btn.innerHTML = '<span class="loader"></span>';
        if(!measurementHistory[p]) measurementHistory[p]=[]; measurementHistory[p].push({date:new Date().toISOString(),value:rV}); await saveData();
        btn.disabled = false; btn.innerHTML = 'üìù Log';
        let burst=document.createElement('div'); burst.className='sparkleBurst'; for(let i=0;i<20;i++){ let dot=document.createElement('div'); dot.className='sparkleDot'; dot.style.setProperty('--x',(Math.random()*250-125)+'px'); dot.style.setProperty('--y',(Math.random()*250-125)+'px'); burst.appendChild(dot); } document.body.appendChild(burst); setTimeout(()=>burst.remove(),600);
        openHistoryPanels.add(p); renderMeasurements();
    }
    if(e.target.classList.contains('historyBtn')){ let p=e.target.dataset.part; if(openHistoryPanels.has(p)) openHistoryPanels.delete(p); else openHistoryPanels.add(p); renderMeasurements(); }
    if(e.target.classList.contains('measureDelete')){ let p=e.target.dataset.part; let i=parseInt(e.target.dataset.index); measurementHistory[p].splice(i,1); await saveData(); renderMeasurements(); }
});

const sM = document.getElementById('settingsModal');
const oS = () => { sM.classList.remove('hidden'); requestAnimationFrame(() => sM.classList.remove('opacity-0')); updateSUI(); };
document.getElementById('openSettingsBtnDesktop').onclick = oS; document.getElementById('openSettingsBtnMobile').onclick = oS;
document.getElementById('closeSettingsBtn').onclick = () => { sM.classList.add('opacity-0'); setTimeout(() => sM.classList.add('hidden'), 300); };
function updateSUI() {
    const sl = document.getElementById('unitSlider'); const bM = document.getElementById('unitMetric'); const bI = document.getElementById('unitImperial');
    if (currentUnit === 'metric') { sl.style.transform = 'translateX(0)'; bM.classList.add('text-white'); bI.classList.add('text-slate-400'); bM.classList.remove('text-slate-400'); bI.classList.remove('text-white'); }
    else { sl.style.transform = 'translateX(100%)'; bI.classList.add('text-white'); bM.classList.add('text-slate-400'); bI.classList.remove('text-slate-400'); bM.classList.remove('text-white'); }
}
document.getElementById('unitMetric').onclick = () => { if(currentUnit!=='metric'){ currentUnit='metric'; localStorage.setItem("eliteUnit", "metric"); updateSUI(); updateAverages(); renderTable(); renderTimeline(); renderMeasurements(); } };
document.getElementById('unitImperial').onclick = () => { if(currentUnit!=='imperial'){ currentUnit='imperial'; localStorage.setItem("eliteUnit", "imperial"); updateSUI(); updateAverages(); renderTable(); renderTimeline(); renderMeasurements(); } };
document.getElementById('signOutBtn').onclick = () => { signOut(auth); sM.classList.add('opacity-0'); setTimeout(() => sM.classList.add('hidden'), 300); };

function updateTabUI(activeId) { ['dashboardTab', 'timelineTab', 'measureTab'].forEach(id => { let el = document.getElementById(id); if(id === activeId) { el.classList.add('bg-indigo-600/40', 'border-indigo-500/50', 'text-white'); el.classList.remove('glass', 'text-slate-400'); } else { el.classList.remove('bg-indigo-600/40', 'border-indigo-500/50', 'text-white'); el.classList.add('glass', 'text-slate-400'); } }); }
document.getElementById('dashboardTab').onclick=()=>{currentTab='dashboard';dashboardView.classList.remove('hidden');timelineView.classList.add('hidden');measureView.classList.add('hidden');updateTabUI('dashboardTab');renderTable(); chart.resize();};
document.getElementById('timelineTab').onclick=()=>{currentTab='timeline';dashboardView.classList.add('hidden');timelineView.classList.remove('hidden');measureView.classList.add('hidden');updateTabUI('timelineTab');renderTimeline()};
document.getElementById('measureTab').onclick=()=>{currentTab='measure';dashboardView.classList.add('hidden');timelineView.classList.add('hidden');measureView.classList.remove('hidden');updateTabUI('measureTab');renderMeasurements()};
document.getElementById("expandBtn").onclick=()=>{if(expansionLevel<2)expansionLevel++;renderTable(); updateAverages(); };
document.getElementById("collapseBtn").onclick=()=>{expansionLevel=0;renderTable(); updateAverages(); };
window.addEventListener('resize', () => { if(currentTab === 'dashboard') chart.resize(); });
</script>
</body>
</html>
